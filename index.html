<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>フォーメーション計算ツール</title>
<style>
  body { font-family: sans-serif; padding: 20px; }
  h2 { margin-top: 40px; }

  .container {
    display: flex;
    gap: 20px;
    align-items: flex-start;
  }

  table { border-collapse: collapse; }

  th, td {
    border: 1px solid #ccc;
    padding: 6px 8px;
    text-align: center;
    white-space: nowrap;
  }

  th { background: #f0f0f0; }

  input[type="checkbox"] {
    transform: scale(1.5);
    cursor: pointer;
  }

  input[type="text"] { width: 170px; }
  input[type="number"] { width: 60px; }

  .result-area { width: 100%; }

  .header-bar {
    display: flex;
    align-items: center;
    gap: 120px;
    padding: 6px 0;
    background: #fff;
    position: sticky;
    top: 0;
    z-index: 2;
  }

  .count { font-size: 16px; font-weight: bold; }
  .count-label { color: #888; font-weight: normal; }

  button { padding: 4px 12px; cursor: pointer; }

  .result-scroll {
    max-height: 640px;
    overflow-y: auto;
    border-top: 1px solid #ccc;
  }

  .combo {
    font-family: monospace;
    display: grid;
    gap: 6px;
    justify-items: center;
  }

  .combo2 { grid-template-columns: 1fr auto 1fr; }
  .combo3 { grid-template-columns: 1fr auto 1fr auto 1fr; }

  .combo .value { font-weight: 700; }

  .odds-very-low  { color: #7A0000; }
  .odds-low       { color: #B00000; }
  .odds-mid-low   { color: #E06666; }
  .odds-mid-high  { color: #6AA84F; }
  .odds-high      { color: #38761D; }
  .odds-very-high { color: #274E13; }
</style>
</head>
<body>

<h2>3連単フォーメーション</h2>

<div class="container">
<table id="triTable">
  <tr>
    <th>馬番</th><th>馬名</th><th>オッズ</th>
    <th>1着</th><th>2着</th><th>3着</th>
  </tr>
</table>

<div class="result-area">
  <div class="header-bar">
    <div class="count">
      <span class="count-label">組み合わせ：</span>
      <span id="triCount">0 点</span>
    </div>
    <button onclick="downloadCSV(triResults,'trifecta')">CSV出力</button>
  </div>

  <div class="result-scroll">
    <table>
      <thead>
        <tr><th>馬番</th><th>馬名</th><th>オッズ</th></tr>
      </thead>
      <tbody id="triResult"></tbody>
    </table>
  </div>
</div>
</div>

<h2>ワイド（2頭）フォーメーション</h2>

<div class="container">
<table id="wideTable">
  <tr>
    <th>馬番</th><th>選択1</th><th>選択2</th>
  </tr>
</table>

<div class="result-area">
  <div class="header-bar">
    <div class="count">
      <span class="count-label">組み合わせ：</span>
      <span id="wideCount">0 点</span>
    </div>
    <button onclick="downloadCSV(wideResults,'wide')">CSV出力</button>
  </div>

  <div class="result-scroll">
    <table>
      <thead>
        <tr><th>馬番</th><th>馬名</th><th>オッズ</th></tr>
      </thead>
      <tbody id="wideResult"></tbody>
    </table>
  </div>
</div>
</div>

<script>
const triResults=[], wideResults=[];
const triTable=document.getElementById("triTable");
const triBody=document.getElementById("triResult");
const triCount=document.getElementById("triCount");

function formatOdds(v){ return isNaN(v)? "-" : Number(v).toFixed(1); }
function oddsClass(v){
  v=Number(v);
  if(v<=5) return "odds-very-low";
  if(v<=10) return "odds-low";
  if(v<=25) return "odds-mid-low";
  if(v<=50) return "odds-mid-high";
  if(v<=100) return "odds-high";
  return "odds-very-high";
}

/* ===== 3連単 入力 ===== */
for(let i=1;i<=18;i++){
  triTable.insertRow().innerHTML=`
    <th>${i}</th>
    <td><input type="text"></td>
    <td><input type="number" step="0.1"></td>
    <td><input type="checkbox" class="p1"></td>
    <td><input type="checkbox" class="p2"></td>
    <td><input type="checkbox" class="p3"></td>`;
}
triTable.addEventListener("input",()=>{updateTrifecta();updateWide();});
triTable.addEventListener("change",()=>{updateTrifecta();updateWide();});

/* ===== ワイド 入力 ===== */
const wideTable=document.getElementById("wideTable");
const wideBody=document.getElementById("wideResult");
const wideCount=document.getElementById("wideCount");

for(let i=1;i<=18;i++){
  wideTable.insertRow().innerHTML=`
    <th>${i}</th>
    <td><input type="checkbox" class="w1"></td>
    <td><input type="checkbox" class="w2"></td>`;
}
wideTable.addEventListener("change",updateWide);

/* ===== 3連単計算 ===== */
function updateTrifecta(){
  triBody.innerHTML=""; triResults.length=0;
  const rows=[...triTable.rows].slice(1);
  const A=[],B=[],C=[];
  rows.forEach(r=>{
    const h={
      no:r.cells[0].textContent,
      name:r.cells[1].children[0].value||"未入力",
      odds:r.cells[2].children[0].value
    };
    if(r.querySelector(".p1").checked)A.push(h);
    if(r.querySelector(".p2").checked)B.push(h);
    if(r.querySelector(".p3").checked)C.push(h);
  });

  let cnt=0;
  A.forEach(a=>B.forEach(b=>C.forEach(c=>{
    if(a.no!==b.no&&a.no!==c.no&&b.no!==c.no){
      cnt++;
      triResults.push({
        no:`${a.no}-${b.no}-${c.no}`,
        name:`${a.name}-${b.name}-${c.name}`,
        odds:`${formatOdds(a.odds)}-${formatOdds(b.odds)}-${formatOdds(c.odds)}`
      });
      triBody.insertRow().innerHTML=`
        <td><div class="combo combo3"><span class="value">${a.no}</span>→<span class="value">${b.no}</span>→<span class="value">${c.no}</span></div></td>
        <td><div class="combo combo3"><span class="value">${a.name}</span>→<span class="value">${b.name}</span>→<span class="value">${c.name}</span></div></td>
        <td><div class="combo combo3">
          <span class="value ${oddsClass(a.odds)}">${formatOdds(a.odds)}</span>→
          <span class="value ${oddsClass(b.odds)}">${formatOdds(b.odds)}</span>→
          <span class="value ${oddsClass(c.odds)}">${formatOdds(c.odds)}</span></div></td>`;
    }
  })));
  triCount.textContent=`${cnt} 点`;
}

/* ===== ワイド計算（3連単入力参照） ===== */
function updateWide(){
  wideBody.innerHTML=""; wideResults.length=0;
  const triRows=[...triTable.rows].slice(1);
  const wRows=[...wideTable.rows].slice(1);
  const A=[],B=[];

  wRows.forEach((r,i)=>{
    const t=triRows[i];
    const h={
      no:t.cells[0].textContent,
      name:t.cells[1].children[0].value||"未入力",
      odds:t.cells[2].children[0].value
    };
    if(r.querySelector(".w1").checked)A.push(h);
    if(r.querySelector(".w2").checked)B.push(h);
  });

  let cnt=0;
  A.forEach(a=>B.forEach(b=>{
    if(a.no<b.no){
      cnt++;
      wideResults.push({
        no:`${a.no}-${b.no}`,
        name:`${a.name}-${b.name}`,
        odds:`${formatOdds(a.odds)}-${formatOdds(b.odds)}`
      });
      wideBody.insertRow().innerHTML=`
        <td><div class="combo combo2"><span class="value">${a.no}</span>→<span class="value">${b.no}</span></div></td>
        <td><div class="combo combo2"><span class="value">${a.name}</span>→<span class="value">${b.name}</span></div></td>
        <td><div class="combo combo2">
          <span class="value ${oddsClass(a.odds)}">${formatOdds(a.odds)}</span>→
          <span class="value ${oddsClass(b.odds)}">${formatOdds(b.odds)}</span></div></td>`;
    }
  }));
  wideCount.textContent=`${cnt} 点`;
}

function downloadCSV(arr,type){
  if(!arr.length){alert("組み合わせがありません");return;}
  let csv="馬番,馬名,オッズ\n";
  arr.forEach(r=>csv+=`"${r.no}","${r.name}","${r.odds}"\n`);
  const a=document.createElement("a");
  a.href=URL.createObjectURL(new Blob([csv],{type:"text/csv"}));
  a.download=`${type}_formation.csv`;
  a.click();
}
</script>

</body>
</html>
